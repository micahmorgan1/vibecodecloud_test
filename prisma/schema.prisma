generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "sqlite"
  url      = "file:./dev.db"
}

// Users - managers and admins who review applicants
model User {
  id        String   @id @default(uuid())
  email     String   @unique
  password  String
  name      String
  role      String   @default("reviewer") // admin, hiring_manager, reviewer
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  tokenVersion  Int      @default(0)

  reviews           Review[]
  jobs              Job[]                @relation("JobCreator")
  assignedJobs      JobReviewer[]
  notificationSubs  JobNotificationSub[]
  createdEvents     RecruitmentEvent[]   @relation("EventCreator")
  eventAttendees    EventAttendee[]
  blockedEmails     BlockedEmail[]
  activityLogs      ActivityLog[]
  notifications     Notification[]
  createdInterviews     Interview[]            @relation("InterviewCreator")
  interviewParticipants InterviewParticipant[] @relation("InterviewParticipant")
  notificationSubsNew   NotificationSub[]      @relation("NotificationSubs")
  eventReviewers        EventReviewer[]
  createdOffers         Offer[]              @relation("OfferCreator")

  // Scoping for hiring managers (null = global access)
  scopedDepartments  String?  // JSON array e.g. '["Design","Engineering"]'
  scopedOffices      String?  // JSON array of office IDs e.g. '["uuid1","uuid2"]'
  scopeMode          String   @default("or") // 'or' = any match, 'and' = must match both department AND office
  eventAccess        Boolean  @default(true) // For HMs: false = cannot see/access events
  offerAccess        Boolean  @default(false) // For HMs: must be explicitly enabled
}

// Job postings
model Job {
  id          String   @id @default(uuid())
  title       String
  slug        String   @unique
  department  String   // e.g., "Design", "Project Management", "Engineering"
  location    String
  type        String   // full-time, part-time, contract, internship
  description      String
  responsibilities String?
  requirements     String
  benefits         String?
  salary      String?
  status      String   @default("open") // open, closed, on-hold
  publishToWebsite Boolean @default(false)
  archived    Boolean  @default(false)
  archivedAt  DateTime?
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt
  closedAt    DateTime?

  // Office association
  officeId    String?
  office      Office?  @relation(fields: [officeId], references: [id])

  // LinkedIn tracking
  postedToLinkedIn   Boolean   @default(false)
  linkedInPostDate   DateTime?
  linkedInPostUrl    String?

  // Other job board tracking
  postedToHandshake  Boolean   @default(false)
  handshakePostDate  DateTime?
  handshakePostUrl   String?

  postedToAIALA      Boolean   @default(false)
  aialaPostDate      DateTime?
  aialaPostUrl       String?

  postedToAIABR      Boolean   @default(false)
  aiabrPostDate      DateTime?
  aiabrPostUrl       String?

  createdBy   User     @relation("JobCreator", fields: [createdById], references: [id])
  createdById String

  applicants        Applicant[]
  reviewers         JobReviewer[]
  notificationSubs  JobNotificationSub[]

  @@index([status, archived])
  @@index([createdById])
}

// Applicants applying for jobs
model Applicant {
  id              String   @id @default(uuid())
  firstName       String
  lastName        String
  email           String
  phone           String?
  linkedIn        String?
  website         String?

  // Resume and portfolio
  resumePath      String?
  portfolioPath   String?
  portfolioUrl    String?  // external portfolio link

  // Application details
  coverLetter     String?

  // Workflow status
  stage           String   @default("new") // new, screening, interview, offer, hired, rejected, holding
  startDate       DateTime? // Expected start date once hired

  // Source tracking
  source          String?  // High-level source: 'Direct Application', 'manual', 'LinkedIn', 'Indeed', etc.
  sourceDetails   String?  // Additional context: UTM parameters, referrer, campaign
  referrer        String?  // HTTP referrer URL
  utmSource       String?  // UTM tracking parameters
  utmMedium       String?
  utmCampaign     String?
  utmContent      String?

  // Spam detection
  spam            Boolean  @default(false)
  spamReason      String?

  // URL safety checking
  urlSafe         Boolean   @default(true)
  urlFlags        String?
  urlCheckedAt    DateTime?

  createdAt       DateTime @default(now())
  updatedAt       DateTime @updatedAt

  job             Job?     @relation(fields: [jobId], references: [id])
  jobId           String?

  eventId         String?
  event           RecruitmentEvent? @relation(fields: [eventId], references: [id])

  reviews         Review[]
  notes           Note[]
  activityLogs    ActivityLog[]
  interviews      Interview[]
  offers          Offer[]

  @@index([jobId])
  @@index([eventId])
  @@index([email])
  @@index([stage])
  @@index([spam])
  @@index([createdAt])
}

// Reviews/ratings from managers
model Review {
  id          String   @id @default(uuid())
  rating      Int      // 1-5 stars

  // Specific criteria ratings for architecture firms
  technicalSkills   Int?  // 1-5
  designAbility     Int?  // 1-5
  portfolioQuality  Int?  // 1-5
  communication     Int?  // 1-5
  cultureFit        Int?  // 1-5

  recommendation    String? // strong_yes, yes, maybe, no, strong_no
  comments          String?

  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  reviewer    User     @relation(fields: [reviewerId], references: [id])
  reviewerId  String

  applicant   Applicant @relation(fields: [applicantId], references: [id])
  applicantId String

  @@unique([reviewerId, applicantId])
  @@index([applicantId])
  @@index([reviewerId])
}

// Internal notes on applicants
model Note {
  id        String   @id @default(uuid())
  content   String
  createdAt DateTime @default(now())

  applicant   Applicant @relation(fields: [applicantId], references: [id])
  applicantId String

  @@index([applicantId])
}

// Configurable email templates
model EmailTemplate {
  id        String   @id @default(uuid())
  type      String   @unique   // 'thank_you' | 'rejection'
  subject   String
  body      String
  updatedAt DateTime @updatedAt
  updatedBy String?
}

// Reviewer-to-job assignments for access control (reviewers only)
model JobReviewer {
  id        String   @id @default(uuid())
  userId    String
  jobId     String
  createdAt DateTime @default(now())
  user      User     @relation(fields: [userId], references: [id], onDelete: Cascade)
  job       Job      @relation(fields: [jobId], references: [id], onDelete: Cascade)
  @@unique([userId, jobId])
  @@index([userId])
}

// Per-user, per-job notification subscriptions (any role)
model JobNotificationSub {
  id        String   @id @default(uuid())
  userId    String
  jobId     String
  createdAt DateTime @default(now())
  user      User     @relation(fields: [userId], references: [id], onDelete: Cascade)
  job       Job      @relation(fields: [jobId], references: [id], onDelete: Cascade)
  @@unique([userId, jobId])
  @@index([jobId])
}

// Recruitment events (job fairs, campus visits, etc.)
model RecruitmentEvent {
  id               String   @id @default(uuid())
  name             String
  type             String   @default("job_fair") // job_fair, campus_visit, info_session
  location         String?
  date             DateTime
  notes            String?
  description      String?  // Public-facing description (separate from internal notes)
  eventUrl         String?  // Link to external event page
  university       String?  // University/institution name
  publishToWebsite Boolean  @default(false)
  createdAt        DateTime @default(now())
  updatedAt        DateTime @updatedAt
  createdById      String
  createdBy        User     @relation("EventCreator", fields: [createdById], references: [id])
  applicants       Applicant[]
  attendees        EventAttendee[]
  eventReviewers   EventReviewer[]

  @@index([date])
  @@index([publishToWebsite, date])
}

// Event attendee assignments (which users attend which events)
model EventAttendee {
  id        String   @id @default(uuid())
  userId    String
  eventId   String
  createdAt DateTime @default(now())
  user      User             @relation(fields: [userId], references: [id], onDelete: Cascade)
  event     RecruitmentEvent @relation(fields: [eventId], references: [id], onDelete: Cascade)
  @@unique([userId, eventId])
  @@index([userId])
}

// Reviewer-to-event assignments for access control (mirrors JobReviewer pattern)
model EventReviewer {
  id        String   @id @default(uuid())
  userId    String
  eventId   String
  createdAt DateTime @default(now())
  user      User             @relation(fields: [userId], references: [id], onDelete: Cascade)
  event     RecruitmentEvent @relation(fields: [eventId], references: [id], onDelete: Cascade)
  @@unique([userId, eventId])
  @@index([userId])
}

// Blocked emails/domains for spam prevention
model BlockedEmail {
  id          String   @id @default(uuid())
  type        String   // "email" or "domain"
  value       String   // lowercased email or domain
  createdAt   DateTime @default(now())
  createdById String
  createdBy   User     @relation(fields: [createdById], references: [id])
  @@unique([type, value])
  @@index([value])
}

// Site-wide settings (About WHLC, etc.)
model SiteSetting {
  id        String   @id @default(uuid())
  key       String   @unique
  value     String
  updatedAt DateTime @updatedAt
}

// Activity audit log
model ActivityLog {
  id          String   @id @default(cuid())
  action      String
  metadata    String?  // JSON-stringified
  createdAt   DateTime @default(now())

  applicantId String?
  applicant   Applicant? @relation(fields: [applicantId], references: [id], onDelete: SetNull)

  userId      String?
  user        User?      @relation(fields: [userId], references: [id], onDelete: SetNull)

  @@index([applicantId])
  @@index([userId])
  @@index([createdAt])
}

// In-app notifications
model Notification {
  id        String   @id @default(cuid())
  type      String   // new_application, review_added, stage_changed, review_request
  title     String
  message   String
  link      String?  // relative URL, e.g. /applicants/:id
  read      Boolean  @default(false)
  createdAt DateTime @default(now())

  userId    String
  user      User     @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([userId, read])
  @@index([userId, createdAt])
}

// Scheduled interviews for applicants
model Interview {
  id          String   @id @default(uuid())
  scheduledAt DateTime
  location    String?
  type        String   @default("in_person") // in_person, video, phone
  notes       String?  // prep notes
  notesUrl    String?  // external meeting notes link (OneNote, Google Docs, etc.)
  status      String   @default("scheduled") // scheduled, completed, cancelled, no_show
  feedback    String?  // post-interview summary
  outcome     String?  // advance, hold, reject
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  applicantId String
  applicant   Applicant @relation(fields: [applicantId], references: [id], onDelete: Cascade)

  createdById String
  createdBy   User @relation("InterviewCreator", fields: [createdById], references: [id])

  participants InterviewParticipant[]

  @@index([applicantId])
  @@index([scheduledAt])
  @@index([status])
}

// Interview panel members with individual feedback
model InterviewParticipant {
  id        String   @id @default(uuid())
  feedback  String?
  rating    Int?     // 1-5
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  interviewId String
  interview   Interview @relation(fields: [interviewId], references: [id], onDelete: Cascade)

  userId String
  user   User @relation("InterviewParticipant", fields: [userId], references: [id], onDelete: Cascade)

  @@unique([interviewId, userId])
  @@index([userId])
}

// Office locations
model Office {
  id        String   @id @default(uuid())
  name      String
  address   String
  city      String
  state     String
  zip       String
  phone     String
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
  jobs      Job[]
}

// Notification subscriptions (job, department, or office)
model NotificationSub {
  id        String   @id @default(uuid())
  type      String   // 'job', 'department', 'office'
  value     String   // jobId, department name, or officeId
  userId    String
  user      User     @relation("NotificationSubs", fields: [userId], references: [id], onDelete: Cascade)
  createdAt DateTime @default(now())
  @@unique([userId, type, value])
  @@index([type, value])
}

// Offer letters and tracking
model Offer {
  id          String    @id @default(uuid())
  status      String    @default("draft") // draft, extended, accepted, declined, rescinded
  filePath    String?
  notes       String?
  salary      String?
  offerDate    DateTime?
  acceptedDate DateTime?
  declinedDate DateTime?
  createdAt   DateTime  @default(now())
  updatedAt   DateTime  @updatedAt

  applicantId String
  applicant   Applicant @relation(fields: [applicantId], references: [id], onDelete: Cascade)

  createdById String
  createdBy   User @relation("OfferCreator", fields: [createdById], references: [id])

  @@index([applicantId])
  @@index([status])
}
